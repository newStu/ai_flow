# Feature Specification: 用户认证系统

**Feature Branch**: `user-authentication`  
**Created**: 2025-12-04  
**Status**: Draft  
**Input**: 为Web应用提供安全、便捷的用户认证系统,支持多种登录方式

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 用户名密码快速登录 (Priority: P1)

已注册用户使用用户名和密码快速登录系统,无需额外验证步骤（除非触发安全规则）。

**Why this priority**: 这是最基础、最常用的登录方式,是用户访问系统的主要入口,必须首先实现。

**Independent Test**: 用户输入正确的用户名和密码后,能在500ms内完成验证并跳转到主页,生成有效会话令牌。

**Acceptance Scenarios**:

1. **Given** 用户在登录页面, **When** 输入正确的用户名和密码并点击登录, **Then** 系统在500ms内验证成功并跳转到主页
2. **Given** 用户输入错误密码, **When** 点击登录, **Then** 显示"用户名或密码错误"提示,不泄露具体哪个字段错误
3. **Given** 用户勾选"记住密码", **When** 登录成功后关闭浏览器再次打开, **Then** 用户仍保持登录状态
4. **Given** 用户连续5次输入错误密码, **When** 第6次尝试登录, **Then** 账户被锁定15分钟并显示锁定提示

---

### User Story 2 - 新用户注册与账户激活 (Priority: P1)

新用户通过填写基本信息创建账户,完成邮箱验证后激活账户。

**Why this priority**: 用户注册是获取新用户的关键流程,与登录同等重要,是系统增长的基础。

**Independent Test**: 新用户填写用户名、密码、邮箱,完成图形验证码和邮箱验证码验证后,账户创建成功并自动登录。

**Acceptance Scenarios**:

1. **Given** 新用户在注册页面, **When** 填写符合规则的用户名(3-20位字母数字下划线)、密码(8-50位含大小写字母数字特殊字符)和邮箱, **Then** 系统验证通过并发送邮箱验证码
2. **Given** 用户输入已存在的用户名, **When** 填写注册表单, **Then** 实时显示"用户名已被使用"提示
3. **Given** 用户收到邮箱验证码, **When** 在5分钟内输入正确验证码, **Then** 账户激活成功并自动登录
4. **Given** 用户输入弱密码, **When** 填写密码字段, **Then** 密码强度指示器显示"弱"并提示增强密码

---

### User Story 3 - 忘记密码重置 (Priority: P2)

用户忘记密码时,通过邮箱验证安全地重置密码。

**Why this priority**: 密码重置是常见需求,直接影响用户能否恢复账户访问,优先级较高但不如登录注册紧急。

**Independent Test**: 用户输入用户名和邮箱,通过邮箱验证码验证身份后,能够设置新密码并成功登录。

**Acceptance Scenarios**:

1. **Given** 用户在忘记密码页面, **When** 输入用户名和注册邮箱并完成图形验证码, **Then** 系统发送6位数字验证码到邮箱
2. **Given** 用户收到验证码, **When** 在5分钟内输入正确验证码和新密码, **Then** 密码重置成功并可用新密码登录
3. **Given** 用户输入的新密码与旧密码相同, **When** 提交密码重置, **Then** 系统提示"新密码不能与近5次使用过的密码相同"
4. **Given** 密码重置成功, **When** 用户尝试使用旧密码登录, **Then** 登录失败显示密码错误

---

### User Story 4 - 邮箱验证码快捷登录 (Priority: P2)

已验证邮箱的用户可以使用邮箱验证码快速登录,无需记住密码。

**Why this priority**: 提供更便捷的登录方式,降低用户记忆负担,但不是核心必需功能。

**Independent Test**: 用户输入已注册的邮箱,收到验证码后在5分钟内输入正确验证码即可登录。

**Acceptance Scenarios**:

1. **Given** 用户在登录页面切换到邮箱登录, **When** 输入已验证的邮箱并点击发送验证码, **Then** 系统在3秒内发送6位数字验证码到邮箱
2. **Given** 用户在1分钟内再次点击发送验证码, **When** 请求发送, **Then** 系统提示"请在XX秒后重试"
3. **Given** 用户收到验证码, **When** 在5分钟内输入正确验证码, **Then** 登录成功并跳转到主页
4. **Given** 验证码已过期(超过5分钟), **When** 用户输入验证码, **Then** 系统提示"验证码已过期,请重新获取"

---

### User Story 5 - 第三方账户登录 (Priority: P3)

用户可以使用Google、GitHub或微信账户快速登录,无需单独注册。

**Why this priority**: 提供更多登录选择,降低注册门槛,但依赖第三方服务,优先级较低。

**Independent Test**: 用户点击第三方登录按钮,完成第三方授权后,自动创建或绑定账户并登录系统。

**Acceptance Scenarios**:

1. **Given** 新用户点击Google登录, **When** 完成Google授权, **Then** 系统自动创建账户并使用Google头像和邮箱登录
2. **Given** 已有账户的用户使用GitHub登录, **When** GitHub邮箱与系统邮箱匹配, **Then** 自动绑定现有账户并登录
3. **Given** 用户微信扫码授权, **When** 授权成功但邮箱未绑定现有账户, **Then** 提示用户绑定现有账户或创建新账户
4. **Given** 第三方授权失败或取消, **When** 返回登录页面, **Then** 显示友好的错误提示并保持在登录页面

---

### User Story 6 - 修改密码 (Priority: P3)

已登录用户可以主动修改密码以增强账户安全。

**Why this priority**: 提供密码管理能力,但不是紧急功能,用户可以通过忘记密码流程替代。

**Independent Test**: 登录用户输入当前密码和符合规则的新密码后,密码更新成功,下次登录需使用新密码。

**Acceptance Scenarios**:

1. **Given** 用户在密码修改页面, **When** 输入正确的当前密码和符合规则的新密码, **Then** 密码更新成功并收到通知
2. **Given** 用户输入错误的当前密码, **When** 提交修改, **Then** 显示"当前密码错误"提示
3. **Given** 用户输入的新密码过于简单, **When** 填写新密码字段, **Then** 密码强度指示器实时显示"弱"并提示增强
4. **Given** 密码修改成功, **When** 用户退出登录, **Then** 必须使用新密码才能重新登录

---

### Edge Cases

- **并发登录场景**: 用户在多个设备同时登录时,系统如何管理会话（最多3个活跃会话,超出时踢出最早的会话）
- **验证码过期边界**: 用户在验证码即将过期时(如第299秒)提交,系统如何处理（服务器时间为准,过期则拒绝）
- **特殊字符处理**: 用户名或密码包含SQL注入、XSS攻击字符时,系统如何防护（输入验证和输出转义）
- **网络中断场景**: 用户在提交登录表单时网络中断,如何避免重复提交（防重复提交令牌）
- **跨时区场景**: 验证码和令牌的过期时间在不同时区如何正确计算（统一使用UTC时间存储）
- **大小写敏感性**: 用户名和邮箱登录时大小写是否敏感（用户名大小写敏感,邮箱不敏感统一转小写）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持用户名+密码登录,密码必须加密存储(bcrypt, salt rounds=12)
- **FR-002**: 系统必须支持邮箱+验证码登录,验证码为6位数字,5分钟有效期
- **FR-003**: 系统必须支持用户注册,包含用户名(3-20位)、密码(8-50位含大小写字母数字特殊字符)、邮箱验证
- **FR-004**: 系统必须提供忘记密码功能,通过邮箱验证码重置密码,重置链接24小时有效
- **FR-005**: 系统必须支持修改密码功能,需验证当前密码,新密码不能与近5次密码重复
- **FR-006**: 系统必须支持第三方登录(Google OAuth 2.0, GitHub OAuth, 微信扫码),自动创建或绑定账户
- **FR-007**: 系统必须实现图形验证码防机器人攻击,验证码5分钟有效
- **FR-008**: 系统必须限制登录失败次数,5次失败后锁定账户15分钟
- **FR-009**: 系统必须限制同一IP登录尝试,每小时最多50次
- **FR-010**: 系统必须限制验证码发送频率,同一邮箱1分钟内只能发送1次
- **FR-011**: 系统必须生成JWT访问令牌(15分钟有效)和刷新令牌(7天有效)
- **FR-012**: 系统必须限制同一用户最多3个活跃会话,超出时自动踢出最早会话
- **FR-013**: 系统必须记录用户登录历史(IP地址、设备、时间)
- **FR-014**: 系统必须在异常登录时发送通知(IP地址或设备变化)
- **FR-015**: 系统必须实现CSRF和XSS防护,所有表单包含CSRF令牌
- **FR-016**: 系统必须提供"记住密码"功能,使用安全cookie存储会话
- **FR-017**: 系统必须支持用户名和邮箱唯一性实时验证
- **FR-018**: 系统必须提供密码强度实时指示(弱/中/强)
- **FR-019**: 系统必须支持键盘导航和快捷键操作
- **FR-020**: 系统必须支持响应式设计,适配桌面(1024px+)、平板(768px+)、移动(375px+)设备

### Key Entities

- **User**: 代表系统用户,包含用户名、邮箱、密码哈希、邮箱验证状态、账户状态(active/inactive/locked)、创建时间、最后登录时间、登录次数
- **UserSession**: 代表用户会话,包含用户ID、令牌哈希、刷新令牌哈希、过期时间、IP地址、User-Agent、创建时间
- **VerificationCode**: 代表验证码记录,包含用户ID、邮箱、验证码、类型(register/login/reset_password/change_password)、是否已使用、过期时间、创建时间
- **OAuthAccount**: 代表第三方账户绑定,包含用户ID、提供商(google/github/wechat)、提供商用户ID、访问令牌、刷新令牌、创建时间

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在2秒内加载登录页面,在500ms内完成登录验证
- **SC-002**: 注册流程完成率达到80%以上（开始注册到账户激活）
- **SC-003**: 邮箱验证码发送成功率达到99%以上,3秒内送达
- **SC-004**: 系统支持1000+并发用户同时在线,100+用户同时登录验证,无性能降级
- **SC-005**: 密码重置流程成功率达到90%以上(发起重置到完成重置)
- **SC-006**: 登录相关的安全漏洞为0（通过渗透测试和安全审计）
- **SC-007**: 用户首次使用成功率达到95%以上（无需查看帮助文档）
- **SC-008**: 系统在正常负载下CPU使用率<60%,内存使用<200MB单实例
- **SC-009**: 代码测试覆盖率>80%(单元测试),主要流程100%覆盖(集成测试)
- **SC-010**: 支持主流浏览器(Chrome 90+, Firefox 88+, Safari 14+, Edge 90+)兼容性100%
